name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Resolve SPM dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project ScreenshotPal.xcodeproj

      - name: Build Release
        run: |
          xcodebuild build \
            -project ScreenshotPal.xcodeproj \
            -scheme ScreenshotPal \
            -configuration Release \
            -derivedDataPath build
      - name: Run Tests
        run: |
          xcodebuild test \
            -project ScreenshotPal.xcodeproj \
            -scheme ScreenshotPalTests \
            -configuration Debug \
            -destination 'platform=macOS'
      - name: Create DMG
        run: |
          APP_PATH="build/Build/Products/Release/ScreenshotPal.app"
          DMG_NAME="ScreenshotPal-${GITHUB_REF_NAME}.dmg"

          mkdir -p dmg_staging
          cp -R "$APP_PATH" dmg_staging/
          ln -s /Applications dmg_staging/Applications

          hdiutil create -volname "ScreenshotPal" \
            -srcfolder dmg_staging \
            -ov -format UDZO \
            "$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_ENV

      - name: Sign DMG with Sparkle EdDSA
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          SPARKLE_BIN=$(find ~/Library/Developer/Xcode/DerivedData -path "*/SourcePackages/artifacts/sparkle/Sparkle/bin" -type d | head -1)
          if [ -z "$SPARKLE_BIN" ]; then
            echo "Error: Sparkle tools not found in DerivedData"
            exit 1
          fi

          SIGN_OUTPUT=$("$SPARKLE_BIN/sign_update" "$DMG_NAME" --ed-key-file <(echo "$SPARKLE_PRIVATE_KEY"))
          echo "SIGN_OUTPUT=$SIGN_OUTPUT" >> $GITHUB_ENV

          # Extract signature and length
          ED_SIGNATURE=$(echo "$SIGN_OUTPUT" | grep -o 'sparkle:edSignature="[^"]*"' | cut -d'"' -f2)
          LENGTH=$(echo "$SIGN_OUTPUT" | grep -o 'length="[^"]*"' | cut -d'"' -f2)
          echo "ED_SIGNATURE=$ED_SIGNATURE" >> $GITHUB_ENV
          echo "DMG_LENGTH=$LENGTH" >> $GITHUB_ENV

      - name: Extract version from app
        run: |
          APP_PATH="build/Build/Products/Release/ScreenshotPal.app"
          VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$APP_PATH/Contents/Info.plist")
          BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$APP_PATH/Contents/Info.plist")
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "APP_BUILD=$BUILD" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.DMG_NAME }}
          generate_release_notes: true

      - name: Update appcast on gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${DMG_NAME}"
          PUB_DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")

          # Clone gh-pages branch
          git clone --branch gh-pages --single-branch "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" gh-pages-repo

          cd gh-pages-repo

          # Create appcast.xml if it doesn't exist
          if [ ! -f appcast.xml ]; then
            cat > appcast.xml << 'XMLEOF'
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>ScreenshotPal</title>
              <link>https://2metres.github.io/ScreenshotPal/appcast.xml</link>
              <description>ScreenshotPal updates</description>
              <language>en</language>
            </channel>
          </rss>
          XMLEOF
          fi

          # Build the new item XML
          NEW_ITEM="    <item>
                <title>Version ${APP_VERSION}</title>
                <pubDate>${PUB_DATE}</pubDate>
                <sparkle:version>${APP_BUILD}</sparkle:version>
                <sparkle:shortVersionString>${APP_VERSION}</sparkle:shortVersionString>
                <enclosure url=\"${DOWNLOAD_URL}\" sparkle:edSignature=\"${ED_SIGNATURE}\" length=\"${DMG_LENGTH}\" type=\"application/octet-stream\" />
              </item>"

          # Insert new item before closing </channel> tag
          sed -i '' "s|</channel>|${NEW_ITEM}\n    </channel>|" appcast.xml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "Update appcast for ${TAG}"
          git push
